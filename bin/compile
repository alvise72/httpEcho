#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

# fail fast
set -e

BIN_DIR=$(cd $(dirname $0); pwd) # absolute path

# parse args
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

#echo "build_dir=$BUILD_DIR"
#echo "cache_dir=$CACHE_DIR"
#echo "env_dir=$ENV_DIR"

#ls -l $1
#ls -l $2
#ls -l $3

mkdir -p $CACHE_DIR
cd $CACHE_DIR

# Install JDL 1.8.0
mkdir jdk
cd jdk
wget -q --no-check-certificate https://dl.dropboxusercontent.com/u/33282416/alfresco/openjdk-1.8.0_40.tar.gz
tar zxf openjdk-1.8.0_40.tar.gz
\rm openjdk-1.8.0_40.tar.gz
cd ..

#Install Tomcat 7.0.59
mv jdk $BUILD_DIR
wget -q --no-check-certificate https://dl.dropboxusercontent.com/u/33282416/alfresco/apache-tomcat-7.0.59.tar.gz
tar zxf apache-tomcat-7.0.59.tar.gz
\rm apache-tomcat-7.0.59.tar.gz
mv apache-tomcat-7.0.59 $BUILD_DIR/tomcat
#cd $BUILD_DIR

# Download Alfresco
wget -q --no-check-certificate https://dl.dropboxusercontent.com/u/33282416/alfresco/alfresco-community-5.0.a.zip
cd $CACHE_DIR
unzip -q alfresco-community-5.0.a.zip
mv alfresco-community-5.0.a $BUILD_DIR/alfresco
#ls -l $BUILD_DIR/alfresco

# Configure Tomcat for using Alfresco
sed -i 's+^shared.loader.*+shared.loader=${catalina.base}/shared/classes,${catalina.base}/shared/lib/*.jar+' $BUILD_DIR/tomcat/conf/catalina.properties

grep shared.loader  $BUILD_DIR/tomcat/conf/catalina.properties
cp $BUILD_DIR/alfresco/web-server/lib/postgresql-9.3-1101-jdbc41.jar $BUILD_DIR/tomcat/lib/
mv $BUILD_DIR/tomcat/conf/server.xml $BUILD_DIR/tomcat/conf/server.xml.orig
curl -l -o $BUILD_DIR/tomcat/conf/server.xml https://dl.dropboxusercontent.com/u/33282416/alfresco/server.xml
mv $BUILD_DIR/tomcat/conf/context.xml $BUILD_DIR/tomcat/conf/context.xml.orig
cat << EOF > $BUILD_DIR/tomcat/conf/context.xml
<?xml version='1.0' encoding='utf-8'?>

<Context>

    
    <WatchedResource>WEB-INF/web.xml</WatchedResource>

    <Valve className="org.apache.catalina.authenticator.SSLAuthenticator" securePagesWithPragma="false" />

</Context>
EOF

cp $BUILD_DIR/alfresco/web-server/webapps/alfresco.war $BUILD_DIR/tomcat/webapps
cp $BUILD_DIR/alfresco/web-server/webapps/share.war $BUILD_DIR/tomcat/webapps
\rm -rf $BUILD_DIR/tomcat/webapps/ROOT
mkdir -p $BUILD_DIR/tomcat/shared/classes
curl -k -o $BUILD_DIR/tomcat/shared/classes/alfresco-global.properties https://dl.dropboxusercontent.com/u/33282416/alfresco/alfresco-global.properties
export JAVA_HOME=$BUILD_DIR/jdk
$BUILD_DIR/tomcat/bin/startup.sh
sleep 5
ps -ef|grep java
tail -20 $BUILD_DIR/tomcat/logs/catalina.out
ping 10.64.12.104
#lsof|grep LIST|grep vcap
#curl http://0.0.0.0:8080
exit 1
